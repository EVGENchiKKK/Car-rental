<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π - AutoRent</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöó</text></svg>">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="index.html" class="logo">
                    <div class="logo-icon">üöó</div>
                    <div>
                        <h1>AutoRent</h1>
                        <p>–ù–∞ –ª—é–±–æ–π —Å–ª—É—á–∞–π</p>
                    </div>
                </a>

                <div class="nav-menu">
                    <a href="index.html" class="nav-item">–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="branches.html" class="nav-item">–§–∏–ª–∏–∞–ª—ã</a>
                    <a href="booking.html" class="nav-item">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</a>
                    <a href="cars.html" class="nav-item">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</a>
                </div>

                <div class="user-menu" id="userMenu">
                    <!-- Will be populated by JS -->
                </div>

                <button class="mobile-menu-btn">‚ò∞</button>
            </nav>
        </div>
    </header>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1 class="page-title">–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h1>
            <p class="page-subtitle">–í—Å–µ –≤–∞—à–∏ –∞—Ä–µ–Ω–¥—ã –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</p>
        </div>
    </section>

    <div class="content-section">
        <div class="container">
            <!-- Auth required message -->
            <div id="authRequired" class="text-center" style="display: none;">
                <div class="card" style="max-width: 500px; margin: 0 auto; padding: 3rem;">
                    <h2>–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                    <p style="margin: 1rem 0; color: #6b7280;">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</p>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <a href="login.html" class="btn btn-primary">–í–æ–π—Ç–∏</a>
                        <a href="register.html" class="btn btn-outline">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    </div>
                </div>
            </div>

            <!-- History content -->
            <div id="historyContent" style="display: none;">
                <!-- Filters -->
                <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">–§–∏–ª—å—Ç—Ä—ã</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                            <select class="form-select" id="statusFilter" onchange="filterBookings()">
                                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</option>
                                <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                                <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
                            <select class="form-select" id="periodFilter" onchange="filterBookings()">
                                <option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
                                <option value="month">–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü</option>
                                <option value="quarter">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞</option>
                                <option value="year">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                            <select class="form-select" id="sortFilter" onchange="filterBookings()">
                                <option value="date-desc">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                                <option value="date-asc">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                                <option value="cost-desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é —Å—Ç–æ–∏–º–æ—Å—Ç–∏</option>
                                <option value="cost-asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —Å—Ç–æ–∏–º–æ—Å—Ç–∏</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Bookings List -->
                <div id="bookingsList">
                    <!-- Will be populated by JS -->
                </div>

                <!-- No bookings message -->
                <div id="noBookingsMessage" class="text-center" style="display: none;">
                    <div class="card" style="padding: 3rem;">
                        <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h3>
                        <p style="color: #6b7280; margin: 1rem 0;">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å –∏ –æ—Ñ–æ—Ä–º–∏—Ç–µ –ø–µ—Ä–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
                        <a href="cars.html" class="btn btn-primary">
                            üöó –í—ã–±—Ä–∞—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
                    <p>–¢–µ–ª–µ—Ñ–æ–Ω: 8 (800) 555-35-35</p>
                    <p>–ó–≤–æ–Ω–æ–∫ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π</p>
                </div>

                <div class="footer-section">
                    <h3>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
                    <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="branches.html">–§–∏–ª–∏–∞–ª—ã</a>
                    <a href="cars.html">–ê–≤—Ç–æ–º–æ–±–∏–ª–∏</a>
                </div>
                
                <div class="footer-section">
                    <h3>–û –∫–æ–º–ø–∞–Ω–∏–∏</h3>
                    <p>–ù–∞–¥–µ–∂–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∞—Ä–µ–Ω–¥—ã –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π. –ù–∞ –ª—é–±–æ–π —Å–ª—É—á–∞–π, –ª—é–±–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å.</p>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 AutoRent. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            </div>
        </div>
    </footer>

    <script>
        let currentUser = null;
        let allBookings = [];
        let filteredBookings = [];

        // Initialize page
        function init() {
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                currentUser = JSON.parse(userData);
                
                document.getElementById('userMenu').innerHTML = `
                    <a href="profile.html" class="nav-item">üë§ ${currentUser.firstName}</a>
                    <a href="history.html" class="nav-item active">üìã –ò—Å—Ç–æ—Ä–∏—è</a>
                    <a href="cards.html" class="nav-item">üí≥ –ö–∞—Ä—Ç—ã</a>
                    <a href="#" onclick="logout()" class="btn btn-outline">–í—ã–π—Ç–∏</a>
                `;
                
                loadBookings();
                document.getElementById('historyContent').style.display = 'block';
            } else {
                document.getElementById('userMenu').innerHTML = `
                    <a href="login.html" class="btn btn-outline">–í–æ–π—Ç–∏</a>
                    <a href="register.html" class="btn btn-primary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                `;
                document.getElementById('authRequired').style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        function loadBookings() {
            const bookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
            allBookings = bookings
                .filter(b => b.user.id === currentUser.id)
                .map(booking => {
                    // Update status based on dates
                    const endDate = new Date(booking.endDate);
                    const today = new Date();
                    
                    if (booking.status === 'confirmed' && endDate < today) {
                        booking.status = 'completed';
                    }
                    
                    return booking;
                });
            
            // Save updated bookings
            const allUserBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
            const updatedBookings = allUserBookings.map(b => {
                if (b.user.id === currentUser.id) {
                    const found = allBookings.find(ab => ab.id === b.id);
                    return found || b;
                }
                return b;
            });
            localStorage.setItem('userBookings', JSON.stringify(updatedBookings));
            
            filteredBookings = [...allBookings];
            filterBookings();
        }

        function filterBookings() {
            const statusFilter = document.getElementById('statusFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            
            // Apply filters
            filteredBookings = allBookings.filter(booking => {
                let matches = true;
                
                // Status filter
                if (statusFilter && booking.status !== statusFilter) {
                    matches = false;
                }
                
                // Period filter
                if (periodFilter) {
                    const bookingDate = new Date(booking.createdAt);
                    const now = new Date();
                    let cutoffDate = new Date();
                    
                    switch (periodFilter) {
                        case 'month':
                            cutoffDate.setMonth(now.getMonth() - 1);
                            break;
                        case 'quarter':
                            cutoffDate.setMonth(now.getMonth() - 3);
                            break;
                        case 'year':
                            cutoffDate.setFullYear(now.getFullYear() - 1);
                            break;
                    }
                    
                    if (bookingDate < cutoffDate) {
                        matches = false;
                    }
                }
                
                return matches;
            });
            
            // Apply sorting
            switch (sortFilter) {
                case 'date-desc':
                    filteredBookings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'date-asc':
                    filteredBookings.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'cost-desc':
                    filteredBookings.sort((a, b) => {
                        const costA = parseInt(a.totalCost.replace(/[^\d]/g, ''));
                        const costB = parseInt(b.totalCost.replace(/[^\d]/g, ''));
                        return costB - costA;
                    });
                    break;
                case 'cost-asc':
                    filteredBookings.sort((a, b) => {
                        const costA = parseInt(a.totalCost.replace(/[^\d]/g, ''));
                        const costB = parseInt(b.totalCost.replace(/[^\d]/g, ''));
                        return costA - costB;
                    });
                    break;
            }
            
            renderBookings();
        }

        function renderBookings() {
            const container = document.getElementById('bookingsList');
            const noMessage = document.getElementById('noBookingsMessage');
            
            if (filteredBookings.length === 0) {
                container.style.display = 'none';
                noMessage.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            noMessage.style.display = 'none';
            
            container.innerHTML = filteredBookings.map(booking => {
                const startDate = new Date(booking.startDate).toLocaleDateString('ru-RU');
                const endDate = new Date(booking.endDate).toLocaleDateString('ru-RU');
                const createdDate = new Date(booking.createdAt).toLocaleDateString('ru-RU');
                
                const statusConfig = {
                    confirmed: { color: '#10b981', text: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ', icon: '‚úÖ' },
                    completed: { color: '#6b7280', text: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ', icon: '‚úÖ' },
                    cancelled: { color: '#ef4444', text: '–û—Ç–º–µ–Ω–µ–Ω–æ', icon: '‚ùå' }
                };
                
                const status = statusConfig[booking.status] || statusConfig.confirmed;
                
                const branchNames = {
                    center: '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –æ—Ñ–∏—Å',
                    airport: '–ê—ç—Ä–æ–ø–æ—Ä—Ç –î–æ–º–æ–¥–µ–¥–æ–≤–æ',
                    metro: '–£ –º–µ—Ç—Ä–æ –ü–∞—Ä–∫ –ö—É–ª—å—Ç—É—Ä—ã',
                    mall: '–¢–¶ –ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–π',
                    business: '–ë–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä –ë–µ–ª–∞—è –ü–ª–æ—â–∞–¥—å'
                };
                
                return `
                    <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
                        <div style="display: grid; grid-template-columns: 120px 1fr auto; gap: 2rem; align-items: start;">
                            <!-- Car Image -->
                            <img src="${booking.car.image}" alt="${booking.car.name}" 
                                 style="width: 120px; height: 80px; object-fit: cover; border-radius: 8px;">
                            
                            <!-- Booking Details -->
                            <div>
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <h3 style="margin: 0;">${booking.car.name}</h3>
                                    <span style="color: ${status.color}; font-weight: 600; font-size: 0.9rem;">
                                        ${status.icon} ${status.text}
                                    </span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; color: #6b7280; font-size: 0.9rem;">
                                    <div>
                                        <strong>–ü–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã:</strong><br>
                                        ${startDate} ${booking.startTime} - ${endDate} ${booking.endTime}
                                    </div>
                                    <div>
                                        <strong>–§–∏–ª–∏–∞–ª:</strong><br>
                                        ${branchNames[booking.branch] || booking.branch}
                                    </div>
                                    <div>
                                        <strong>–î–∞—Ç–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</strong><br>
                                        ${createdDate}
                                    </div>
                                </div>
                                
                                ${booking.services && booking.services.length > 0 ? `
                                    <div style="margin-top: 1rem;">
                                        <strong style="color: #374151;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏:</strong>
                                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                            ${booking.services.map(service => {
                                                const serviceNames = {
                                                    gps: 'GPS-–Ω–∞–≤–∏–≥–∞—Ç–æ—Ä',
                                                    'child-seat': '–î–µ—Ç—Å–∫–æ–µ –∫—Ä–µ—Å–ª–æ',
                                                    wifi: 'Wi-Fi —Ä–æ—É—Ç–µ—Ä',
                                                    driver: '–õ–∏—á–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å'
                                                };
                                                return `<span class="car-feature">${serviceNames[service] || service}</span>`;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${booking.comments ? `
                                    <div style="margin-top: 1rem;">
                                        <strong style="color: #374151;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</strong>
                                        <p style="margin: 0.5rem 0 0 0; color: #6b7280;">${booking.comments}</p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Price and Actions -->
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6; margin-bottom: 1rem;">
                                    ${booking.totalCost}
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    ${booking.status === 'confirmed' ? `
                                        <button onclick="cancelBooking('${booking.id}')" 
                                                class="btn" style="background: #ef4444; color: white; font-size: 0.9rem; padding: 0.5rem 1rem;">
                                            –û—Ç–º–µ–Ω–∏—Ç—å
                                        </button>
                                    ` : ''}
                                    
                                    <button onclick="repeatBooking('${booking.id}')" 
                                            class="btn btn-outline" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                                        –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function cancelBooking(bookingId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ?')) {
                return;
            }
            
            // Update booking status
            const allUserBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
            const updatedBookings = allUserBookings.map(booking => {
                if (booking.id === bookingId) {
                    booking.status = 'cancelled';
                }
                return booking;
            });
            
            localStorage.setItem('userBookings', JSON.stringify(updatedBookings));
            
            // Reload bookings
            loadBookings();
            
            alert('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
        }

        function repeatBooking(bookingId) {
            const booking = allBookings.find(b => b.id === bookingId);
            if (booking) {
                localStorage.setItem('selectedCar', JSON.stringify(booking.car));
                window.location.href = 'booking.html';
            }
        }

        // Mobile menu toggle
        document.querySelector('.mobile-menu-btn').addEventListener('click', function() {
            const navMenu = document.querySelector('.nav-menu');
            navMenu.style.display = navMenu.style.display === 'flex' ? 'none' : 'flex';
        });

        // Initialize page
        init();
    </script>
</body>
</html>